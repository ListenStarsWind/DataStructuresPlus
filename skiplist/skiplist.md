# skiplist  

## 引言

跳表, 是一种用于进行查找的数据结构, 它最早由威廉·普格(William Pugh)于1990年于论文 `Skip Lists: A Probabilistic Alternative to Balanced Trees  `中提出, 论文的下载链接[如下](https://ftp.cs.umd.edu/pub/skipLists/skiplists.pdf)

跳表, 是在有序链表的基础上发展而来的, 我们知道, 对于一个有序的链表来说, 进行数据查找的时间复杂度是$O(N)$.  威廉·普格为了对其进行优化, 最开始提出这样的设想. 

假如我们每相邻两个节点升高一层，增加一个指针，让指针指向下下个节点，如下图a所示。这样所有新增加的指针连成了一个新的链表，但它包含的节点个数只有原来的一半。由于新增加的指针，我们不再需要与链表中每个节点逐个进行比较了，需要比较的节点数大概只有原来的一半。

以此类推，我们可以在第二层新产生的链表上，继续为每相邻的两个节点升高一层，增加一个指针，从而产生第三层链表。如下图b这样搜索效率就进一步提高了.

![image-20250525205607150](https://md-wind.oss-cn-nanjing.aliyuncs.com/md/20250525205607213.png)

skiplist正是受这种多层链表的想法的启发而设计出来的。实际上，按照上面生成链表的方式，上面每一层链表的节点个数，是下面一层的节点个数的一半，这样查找过程就非常类似二分查找，使得查找的时间复杂度可以降低到$O(log_2N)$, 

不过这种机制引入了新的问题, 那就是对新数据的插入删除造成了困扰. 因为这种链表的结构太规整了, 所以如果要删除插入新的数据, 就要对各个层进行重新调整, 否则就会破坏原先的规则.

威廉·普格为了避免这种问题，做了一个大胆的处理，不再严格要求对应比例关系，而是插入一个节点的时候随机出一个层数。这样每次插入和删除都不需要考虑其他节点的层数，这样就好处理多了。细节过程入下图：  

![image-20250525210009992](https://md-wind.oss-cn-nanjing.aliyuncs.com/md/20250525210010034.png)

在上图中, 我们要找17这个关键字, 最开始, 我们从表头出发, 先使用最高层的链表, 发现下一个节点的值为6, 比17小, 所以来到6这个节点, 接下来, 发现下一个节点是空, 空说明这层链表已经没了, 所以我们就要来到下一层, 下一层的下一个节点是25, 比17大, 这说明, 17的位置应该在6和25这两个节点之间, 所以我们再次下降高度, 来到第三层的链表, 此时下一个节点是9, 比17小, 于是来到这里, 接下来, 下一个节点是25, 比17大, 所以来到第四层, 下一个节点是12, 比17小, 所以继续往后来到12, 12往后是19, 19比17大, 而又没有更低的链表了, 所以17应该插入到12这个链表的后面(对于底层链表来说).

然后, 他随机生成一个层数, 是2, 那么17这个节点的高度就是2, 最底层的前驱节点是12, 次底层的前驱节点就是9.

这个随机也不是乱随机的, 他遵循一定的概率的, 伪代码如下

![image-20250525212615307](https://md-wind.oss-cn-nanjing.aliyuncs.com/md/20250525212615343.png)

最开始层数就是1, 然后定义一个概率`p`, 描述, 向上再增加一层的概率, 就是说, 如果现在已经是一层了, 那么又`p`的概率变成两层, 也有`1-p`的概率就停在一层, 还有一个`MaxLevel`, 表示允许的最高高度.

随机一个深度, 输出一层的概率是`1-p`, 也就是在第一层就触发了`(1-p)`的这个不上升的概率
输出二层的概率是`p * (1-p)`, 首先, 你需要从一层上升到二层, 这是`p`的概率, 其次你停在了二层, 所以再乘上`1-p`
输出三层的概率是$p^2 * (1-p)$
输出`h`层的概率是$p^{h-1} * (1-p)$

跳表在一些数据库里面也会用, 不过这是和MySQL已经完全不同的数据库了, 比如MemSQL, 这是一个专门用于进行内存管理的数据库, 还有谷歌的LevelDB.也是一个数据库. 

![image-20250525214344689](https://md-wind.oss-cn-nanjing.aliyuncs.com/md/20250525214344737.png)

跳表的时间复杂度这里不推导了, 较为复杂, 只能说, 和搜索树的级别相同$O(log_2n)$, 具体可以看威廉·普格的论文, 或者是这篇[文章](http://zhangtielei.com/posts/blog-redis-skiplist.html)

## 简单实现

下面我们结合力扣的[1206. 设计跳表](https://leetcode.cn/problems/design-skiplist/)这题, 来简单实现一个跳表.